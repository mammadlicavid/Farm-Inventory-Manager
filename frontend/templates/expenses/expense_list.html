{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="dashboard-container">
    <header class="main-header" style="padding-bottom: 60px;">
        <div class="header-content">
            <div class="header-top">
                <a href="{% url 'dashboard' %}" class="back-btn-box">
                    <i class="fa-solid fa-arrow-left"></i>
                    <span>Xərclər</span>
                </a>
            </div>
        </div>
    </header>

    <main class="main-content" style="margin-top: -40px; position: relative; z-index: 10;">
        <!-- Weekly Summary Card -->
        <div class="summary-card-cream">
            <span class="label">Bu həftə ümumi xərc</span>
            <span class="value">{{ weekly_total|floatformat:0 }}₼</span>
        </div>

        <form action="{% url 'expenses:delete_expense' expense.pk %}" method="POST"
            style="display: flex; align-items: center; margin: 0; padding: 0; height: 24px;"
            onsubmit="return confirm('Silmək istədiyinizə əminsiniz?');">
            {% csrf_token %}
            <button type="submit"
                style="background:none; border:none; color: #dc3545; cursor:pointer; font-size: 14px; display: flex; align-items: center; gap: 4px; padding: 0; margin: 0; height: 24px; line-height: 1;">
                <i class="fa-solid fa-trash"></i> Sil
            </button>
        </form>
</div>
</div>
</div>
</div>
{% empty %}
<div style="text-align: center; padding: 40px; color: #999;">
    <p>Hələ heç bir xərc qeydə alınmayıb</p>
</div>
{% endfor %}
</div>
</main>
</div>

<script>
    const subcategoryData = {
        {% for cat in categories %}
    "{{ cat.id }}": [
        {% for sub in cat.subcategories.all %}
    { "id": "{{ sub.id }}", "name": "{{ sub.name }}" },
    {% endfor %}
            ],
    {% endfor %}
    };

    const categorySelect = document.getElementById('category-select');
    const subcategorySelect = document.getElementById('subcategory-select');

    categorySelect.addEventListener('change', function () {
        const categoryId = this.value;
        const categoryText = this.options[this.selectedIndex].text;
        const subcats = subcategoryData[categoryId] || [];
        const subcategoryGroup = document.getElementById('subcategory-field-group');
        const manualGroup = document.getElementById('manual-name-group');
        const manualInput = document.getElementById('manual-name-input');

        if (categoryText === "Digər" || categoryText.includes("Digər")) {
            subcategoryGroup.style.display = 'none';
            subcategorySelect.required = false;
            subcategorySelect.disabled = true;

            manualGroup.style.display = 'block';
            manualInput.required = true;
        } else {
            manualGroup.style.display = 'none';
            manualInput.required = false;
            manualInput.value = '';

            subcategoryGroup.style.display = 'block';
            subcategorySelect.required = true;

            subcategorySelect.innerHTML = '<option value="" disabled selected>Alt kateqoriya seçin</option>';

            subcats.forEach(sub => {
                const option = document.createElement('option');
                option.value = sub.id;
                option.textContent = sub.name;
                subcategorySelect.appendChild(option);
            });

            subcategorySelect.disabled = false;
        }
    });
</script>
{% endblock %}